<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Experiment Results</title>
  <style>
    :root {
      --bg: #111827;
      --surface: #1f2937;
      --border: #374151;
      --text: #f9fafb;
      --muted: #9ca3af;
      --accent: #3b82f6;
      --success: #22c55e;
      --error: #ef4444;
    }
    body {
      margin: 0;
      font-family: system-ui, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 2rem;
    }
    h1 { margin-top: 0; }
    .result {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
    }
    .header {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: .5rem;
    }
    .badge { margin-left: .5rem; }
    .field { margin: .4rem 0; }
    .field span { font-weight: 600; color: var(--muted); }
    pre {
      background: var(--bg);
      color: var(--text);
      padding: .8rem;
      border-radius: 6px;
      overflow: auto;
      font-size: .9rem;
    }
  </style>
</head>
<body>

<h1>Experiment Results</h1>

<!-- Dropdown to choose a subdirectory -->
<select id="dirSelect" style="margin-bottom:1rem; padding:.4rem; font-size:1.2rem;">
  <!-- options will be injected by script -->
</select>

<div id="container">Loading…</div>

<script>
(async () => {
  const container = document.getElementById('container');
  const dirSelect = document.getElementById('dirSelect');

  // Helper: fetch and parse links from a directory listing page
  const fetchLinks = async (path) => {
    const resp = await fetch(path + '?list');
    const html = await resp.text();
    const doc  = new DOMParser().parseFromString(html, 'text/html');
    return [...doc.querySelectorAll('a')]
      .map(a => a.getAttribute('href'))
      .filter(h => h);
  };

  // Helper: format token count in thousands with up to 2 decimals (e.g., 1230 → 1.23K)
  const formatTokens = (count) => {
    const num = Number(count);
    if (isNaN(num)) return count;
    const k = num / 1000;
    // Trim unnecessary trailing zeros
    const formatted = k.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 2});
    return `${formatted}K`;
  };

  // Load sub‑directories for the dropdown
  const rootLinks = await fetchLinks('./');
  const subDirs = rootLinks
    .filter(h => h.endsWith('/') && !h.startsWith('?')) // keep only directories
    .map(h => h.replace(/^\.?\//, '').replace(/\/$/, '')); // normalize

  // Sort directories so the newest (lexicographically highest) appears first
  subDirs.sort((a, b) => b.localeCompare(a));

  // Populate dropdown
  subDirs.forEach((d, i) => {
    const opt = document.createElement('option');
    opt.value = d;
    opt.textContent = d || '/';
    if (i === 0) opt.selected = true;   // first entry is now the most recent folder
    dirSelect.appendChild(opt);
  });

  // Function to load and display results from a given directory
  const loadResults = async (dir) => {
    container.innerHTML = '<p>Loading…</p>';

    // Get JSON file links inside the chosen subdirectory
    const jsonLinks = (await fetchLinks(`${dir}/`))
      .filter(h => h.toLowerCase().endsWith('.json'))
      .map(h => `${dir}/${h.replace(/^\.?\//, '').replace(/\?.*$/, '')}`);

    if (jsonLinks.length === 0) {
      container.innerHTML = '<p>No JSON files found.</p>';
      return;
    }

    const results = await Promise.all(
      jsonLinks.map(async name => {
        const resp = await fetch(name);
        const data = await resp.json();
        return { ...data, _filename: name };
      })
    );

    // Sort by id (you can switch to date sort if desired)
    results.sort((a, b) => a.id.localeCompare(b.id));

    container.innerHTML = '';
    results.forEach(r => {
      const badge = r.passed ? '✅' : '❌';
      const el = document.createElement('div');
      el.className = 'result';
      el.innerHTML = `
        <div class="header">
          Experiment ID: ${r.id}
          <span class="badge">${badge}</span>
        </div>
        <div class="field"><span>Model:</span> ${r.model}</div>
        <div class="field"><span>Query:</span> ${r.query}</div>
        <div class="field"><span>Expected answer:</span> ${r.expected_answer}</div>
        <div class="field"><span>Input context:</span> ${formatTokens(r.input_tokens)}</div>
        <div class="field"><span>Output:</span></div>
        <pre>${r.output}</pre>
        <div class="field"><small>Source file: ${r._filename}</small></div>
      `;
      container.appendChild(el);
    });
  };

  // Initial load with the first (most‑recent) subdirectory
  if (subDirs.length > 0) {
    loadResults(subDirs[0]);
  } else {
    container.innerHTML = '<p>No subdirectories found.</p>';
  }

  // Reload results when the user selects a different directory
  dirSelect.addEventListener('change', (e) => {
    loadResults(e.target.value);
  });

})();
</script>

</body>
</html>
